name: ESLint with Reviewdog

on:
  pull_request:
    branches: [main]

jobs:
  eslint:
    name: Run ESLint
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write # ✅ This is critical for commenting on PRs

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0 # ✅ Get full git history for proper diff comparison

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18
          cache: 'npm' # ✅ Enable caching for faster runs

      - name: Install dependencies
        run: npm ci

      # ✅ Added a debug step to check if ESLint is properly installed
      - name: Verify ESLint installation
        run: |
          npx eslint --version
          ls -la node_modules/.bin/

      # ✅ Run ESLint directly first to see any errors in the logs
      - name: Run ESLint directly
        continue-on-error: true
        run: npx eslint './src/**/*.{ts,tsx}' --format stylish

      - name: Run ESLint via Reviewdog
        uses: reviewdog/action-eslint@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          reporter: github-pr-review
          eslint_flags: './src/**/*.{ts,tsx}'
          fail_level: none # ✅ Ensure workflow doesn't fail on ESLint errors
          level: warning
          filter_mode: nofilter
